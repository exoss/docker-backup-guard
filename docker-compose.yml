version: '3.8'

services:
  socket-proxy:
    image: tecnativa/docker-socket-proxy
    container_name: docker-socket-proxy
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - CONTAINERS=1
      - POST=1
      # Explicitly deny potentially dangerous capabilities
      - BUILD=0
      - COMMIT=0
      - CONFIGS=0
      - DISTRIBUTION=0
      - EXEC=0
      - IMAGES=1
      - NETWORKS=0
      - NODES=0
      - PLUGINS=0
      - SERVICES=0
      - SESSION=0
      - SWARM=0
      - SYSTEM=0
      - TASKS=0
      - VOLUMES=0
      - SECRETS=0
    networks:
      - backup-net

  docker-backup-guard:
    build: .
    container_name: docker-backup-guard
    restart: unless-stopped
    ports:
      - "8501:8501"
    environment:
      - TZ=Europe/Berlin
      - DOCKER_HOST=tcp://socket-proxy:2375
    volumes:
      # Removed direct Docker Socket mount
      # Persistence for configuration file
      - ./.env:/app/.env
      # Backup storage (Mapped to ./backups on host)
      - ./backups:/backups
      # Logs persistence
      - ./logs:/app/logs
      # Rclone configuration (Directly mounted as file)
      - ./config/rclone/rclone.conf:/app/rclone.conf
      # Read-only access to Docker volumes for smart detection
      - /var/lib/docker/volumes:/var/lib/docker/volumes:ro
      # Access to Host Filesystem for Bind Mounts
      - /:/hostfs:ro
    depends_on:
      - socket-proxy
    networks:
      - backup-net

networks:
  backup-net:
    driver: bridge
